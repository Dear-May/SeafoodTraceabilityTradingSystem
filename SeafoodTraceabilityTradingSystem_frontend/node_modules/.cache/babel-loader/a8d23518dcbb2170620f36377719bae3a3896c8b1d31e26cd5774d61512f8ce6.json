{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { createVNode as _createVNode, createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode, toDisplayString as _toDisplayString, resolveComponent as _resolveComponent, withCtx as _withCtx, createTextVNode as _createTextVNode, openBlock as _openBlock, createBlock as _createBlock, renderList as _renderList, Fragment as _Fragment, createElementBlock as _createElementBlock, Transition as _Transition, vModelText as _vModelText, withKeys as _withKeys, withDirectives as _withDirectives, resolveDirective as _resolveDirective } from \"vue\";\nconst _hoisted_1 = {\n  class: \"my-haichao-page\"\n};\nconst _hoisted_2 = {\n  class: \"live-stream-container\"\n};\nconst _hoisted_3 = {\n  class: \"header bg-light d-flex align-items-center p-3 shadow-sm row\"\n};\nconst _hoisted_4 = {\n  class: \"col-7 row\"\n};\nconst _hoisted_5 = {\n  class: \"col-3 row\"\n};\nconst _hoisted_6 = {\n  class: \"col-3\"\n};\nconst _hoisted_7 = [\"src\"];\nconst _hoisted_8 = {\n  class: \"col-9\"\n};\nconst _hoisted_9 = {\n  class: \"shop-name\",\n  style: {\n    \"font-size\": \"16px\"\n  }\n};\nconst _hoisted_10 = {\n  class: \"shop-desc\",\n  style: {\n    \"font-size\": \"14px\"\n  }\n};\nconst _hoisted_11 = {\n  class: \"col-7\",\n  style: {\n    \"margin-top\": \"15px\"\n  }\n};\nconst _hoisted_12 = {\n  class: \"col-4\",\n  style: {\n    \"margin-top\": \"15px\",\n    \"text-align\": \"end\"\n  }\n};\nconst _hoisted_13 = {\n  class: \"content-container d-flex\"\n};\nconst _hoisted_14 = {\n  class: \"video-section flex-grow-1\"\n};\nconst _hoisted_15 = {\n  id: \"video2\",\n  ref: \"video2\",\n  autoplay: \"\",\n  style: {\n    \"width\": \"100%\",\n    \"height\": \"100%\",\n    \"object-fit\": \"cover\"\n  }\n};\nconst _hoisted_16 = {\n  class: \"side-panel bg-light p-3\"\n};\nconst _hoisted_17 = {\n  class: \"online-users mb-4\"\n};\nconst _hoisted_18 = {\n  class: \"text-danger\"\n};\nconst _hoisted_19 = {\n  class: \"list-unstyled\"\n};\nconst _hoisted_20 = [\"src\"];\nconst _hoisted_21 = {\n  class: \"chat-section\"\n};\nconst _hoisted_22 = {\n  class: \"chat-messages border rounded p-2 mb-3\",\n  ref: \"chatWindowRef\"\n};\nconst _hoisted_23 = [\"src\"];\nconst _hoisted_24 = {\n  class: \"mb-1\"\n};\nconst _hoisted_25 = [\"innerHTML\"];\nconst _hoisted_26 = {\n  style: {\n    \"text-align\": \"start\"\n  }\n};\nconst _hoisted_27 = {\n  class: \"input-group\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_rate = _resolveComponent(\"el-rate\");\n  const _component_el_tag = _resolveComponent(\"el-tag\");\n  const _component_el_button = _resolveComponent(\"el-button\");\n  const _component_emoji_picker = _resolveComponent(\"emoji-picker\");\n  const _directive_loading = _resolveDirective(\"loading\");\n  return _openBlock(), _createElementBlock(_Fragment, null, [_createElementVNode(\"div\", _hoisted_1, [_createVNode($setup[\"HeaderComponent\"]), _withDirectives((_openBlock(), _createElementBlock(\"div\", _hoisted_2, [_createCommentVNode(\" 头部信息 \"), _createElementVNode(\"div\", _hoisted_3, [_createElementVNode(\"div\", _hoisted_4, [_createElementVNode(\"div\", _hoisted_5, [_createElementVNode(\"div\", _hoisted_6, [_createElementVNode(\"img\", {\n    src: $setup.shopForm.avatar,\n    class: \"shop-avatar\",\n    alt: \"shop-avatar\",\n    width: \"50\",\n    height: \"50\"\n  }, null, 8 /* PROPS */, _hoisted_7)]), _createElementVNode(\"div\", _hoisted_8, [_createElementVNode(\"p\", _hoisted_9, _toDisplayString($setup.shopForm.name), 1 /* TEXT */), _createElementVNode(\"p\", _hoisted_10, _toDisplayString($setup.shopForm.description), 1 /* TEXT */)])]), _createElementVNode(\"div\", _hoisted_11, [_createVNode(_component_el_tag, {\n    type: \"danger\"\n  }, {\n    default: _withCtx(() => [_createVNode(_component_el_rate, {\n      modelValue: $setup.value,\n      \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $setup.value = $event),\n      disabled: \"\",\n      \"show-score\": \"\",\n      \"text-color\": \"#e23030\",\n      \"score-template\": \"|  {value}\"\n    }, null, 8 /* PROPS */, [\"modelValue\"])]),\n    _: 1 /* STABLE */\n  }), _cache[9] || (_cache[9] = _createTextVNode(\"   \")), _createVNode(_component_el_tag, {\n    type: \"info\"\n  }, {\n    default: _withCtx(() => _cache[6] || (_cache[6] = [_createTextVNode(\" 客服满意度96% \")])),\n    _: 1 /* STABLE */\n  }), _cache[10] || (_cache[10] = _createTextVNode(\"   \")), _createVNode(_component_el_tag, {\n    type: \"info\"\n  }, {\n    default: _withCtx(() => _cache[7] || (_cache[7] = [_createTextVNode(\" 平均13小时发货 \")])),\n    _: 1 /* STABLE */\n  }), _cache[11] || (_cache[11] = _createTextVNode(\"   \")), _createVNode(_component_el_tag, {\n    type: \"info\"\n  }, {\n    default: _withCtx(() => _cache[8] || (_cache[8] = [_createTextVNode(\" 物流体验优秀 \")])),\n    _: 1 /* STABLE */\n  })])]), _cache[16] || (_cache[16] = _createElementVNode(\"div\", {\n    class: \"col-1 row\",\n    style: {\n      \"text-align\": \"start\"\n    }\n  }, null, -1 /* HOISTED */)), _createElementVNode(\"div\", _hoisted_12, [_createVNode(_component_el_button, {\n    onClick: _cache[1] || (_cache[1] = () => {\n      $setup.router.push('/talkToStore?id=' + $setup.LiveId);\n    })\n  }, {\n    default: _withCtx(() => _cache[12] || (_cache[12] = [_createElementVNode(\"a\", {\n      class: \"bi bi-chat\"\n    }, null, -1 /* HOISTED */), _createTextVNode(\"  联系客服 \")])),\n    _: 1 /* STABLE */\n  }), _createVNode(_component_el_button, {\n    onClick: _cache[2] || (_cache[2] = () => {\n      $setup.router.push('/shop?shopId=' + $setup.LiveId);\n    })\n  }, {\n    default: _withCtx(() => _cache[13] || (_cache[13] = [_createElementVNode(\"a\", {\n      class: \"bi bi-house\"\n    }, null, -1 /* HOISTED */), _createTextVNode(\" 进入店铺 \")])),\n    _: 1 /* STABLE */\n  }), !$setup.followed ? (_openBlock(), _createBlock(_component_el_button, {\n    key: 0,\n    onClick: _cache[3] || (_cache[3] = $event => $setup.followShop())\n  }, {\n    default: _withCtx(() => _cache[14] || (_cache[14] = [_createElementVNode(\"a\", {\n      class: \"bi bi-share-fill\"\n    }, null, -1 /* HOISTED */), _createTextVNode(\" 关注店铺 \")])),\n    _: 1 /* STABLE */\n  })) : (_openBlock(), _createBlock(_component_el_button, {\n    key: 1,\n    onClick: _cache[4] || (_cache[4] = $event => $setup.unFollowShop())\n  }, {\n    default: _withCtx(() => _cache[15] || (_cache[15] = [_createElementVNode(\"a\", {\n      class: \"bi bi-share-fill\"\n    }, null, -1 /* HOISTED */), _createTextVNode(\" 取消关注 \")])),\n    _: 1 /* STABLE */\n  }))])]), _createCommentVNode(\" 主体内容 \"), _createElementVNode(\"div\", _hoisted_13, [_createCommentVNode(\" 视频播放区 \"), _createElementVNode(\"div\", _hoisted_14, [_createElementVNode(\"video\", _hoisted_15, null, 512 /* NEED_PATCH */)]), _createCommentVNode(\" 在线用户和聊天区域 \"), _createElementVNode(\"div\", _hoisted_16, [_createCommentVNode(\" 在线用户列表 \"), _createElementVNode(\"div\", _hoisted_17, [_createElementVNode(\"h6\", _hoisted_18, \"在线人员 (\" + _toDisplayString($setup.onlineUsers.length) + \")\", 1 /* TEXT */), _createElementVNode(\"ul\", _hoisted_19, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.onlineUsers, (user, index) => {\n    return _openBlock(), _createElementBlock(\"li\", {\n      key: index,\n      class: \"d-flex align-items-center mb-2\"\n    }, [_createElementVNode(\"img\", {\n      class: \"user-avatar-sm rounded-circle me-2\",\n      src: user.avatar,\n      alt: \"用户头像\"\n    }, null, 8 /* PROPS */, _hoisted_20), _createElementVNode(\"span\", null, _toDisplayString(user.name), 1 /* TEXT */)]);\n  }), 128 /* KEYED_FRAGMENT */))])]), _createCommentVNode(\" 聊天区 \"), _createElementVNode(\"div\", _hoisted_21, [_cache[18] || (_cache[18] = _createElementVNode(\"h6\", {\n    class: \"text-primary\"\n  }, \"聊天区\", -1 /* HOISTED */)), _createElementVNode(\"div\", _hoisted_22, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.chatMessages, (message, index) => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: index,\n      class: \"d-flex align-items-start mb-2\"\n    }, [_createElementVNode(\"img\", {\n      class: \"user-avatar-sm rounded-circle me-2\",\n      src: message.avatar,\n      alt: \"用户头像\",\n      width: \"35\",\n      height: \"35\"\n    }, null, 8 /* PROPS */, _hoisted_23), _createElementVNode(\"div\", null, [_createElementVNode(\"p\", _hoisted_24, [_createElementVNode(\"strong\", null, _toDisplayString(message.sender), 1 /* TEXT */), message.type === 'shop' && message.id === $setup.LiveId.value ? (_openBlock(), _createBlock(_component_el_tag, {\n      key: 0,\n      type: \"danger\"\n    }, {\n      default: _withCtx(() => [...(_cache[17] || (_cache[17] = [_createTextVNode(\" 商家 \")]))]),\n      _: 1 /* STABLE */\n    })) : _createCommentVNode(\"v-if\", true)]), _createElementVNode(\"p\", {\n      class: \"text-muted mb-0\",\n      innerHTML: message.content\n    }, null, 8 /* PROPS */, _hoisted_25)])]);\n  }), 128 /* KEYED_FRAGMENT */))], 512 /* NEED_PATCH */), _createCommentVNode(\" 聊天输入框 \"), _createElementVNode(\"div\", _hoisted_26, [_createVNode(_Transition, {\n    name: \"fade\"\n  }, {\n    default: _withCtx(() => [$setup.showEmojiPicker ? (_openBlock(), _createBlock(_component_emoji_picker, {\n      key: 0,\n      onEmojiClick: $setup.addEmoji,\n      style: {\n        \"position\": \"absolute\",\n        \"bottom\": \"200px\",\n        \"right\": \"100px\"\n      }\n    })) : _createCommentVNode(\"v-if\", true)]),\n    _: 1 /* STABLE */\n  }), _createElementVNode(\"i\", {\n    class: \"bi bi-emoji-smile me-3\",\n    style: {\n      \"font-size\": \"1.5rem\",\n      \"cursor\": \"pointer\"\n    },\n    onClick: $setup.toggleEmojiPicker\n  })]), _createElementVNode(\"div\", _hoisted_27, [_withDirectives(_createElementVNode(\"input\", {\n    type: \"text\",\n    \"onUpdate:modelValue\": _cache[5] || (_cache[5] = $event => $setup.chatInput = $event),\n    class: \"form-control\",\n    placeholder: \"输入50字以内聊天内容~\",\n    maxlength: \"50\",\n    onKeyup: _withKeys($setup.sendMessage, [\"enter\"])\n  }, null, 544 /* NEED_HYDRATION, NEED_PATCH */), [[_vModelText, $setup.chatInput]]), _createElementVNode(\"button\", {\n    class: \"btn btn-danger\",\n    onClick: $setup.sendMessage\n  }, \"发送\")])])])])])), [[_directive_loading, $setup.loading]])]), _createVNode($setup[\"FooterComponent\"]), _createVNode($setup[\"RightWidgetComponent\"])], 64 /* STABLE_FRAGMENT */);\n}","map":{"version":3,"names":["class","style","id","ref","autoplay","_createElementBlock","_Fragment","_createElementVNode","_hoisted_1","_createVNode","$setup","_hoisted_2","_createCommentVNode","_hoisted_3","_hoisted_4","_hoisted_5","_hoisted_6","src","shopForm","avatar","alt","width","height","_hoisted_7","_hoisted_8","_hoisted_9","_toDisplayString","name","_hoisted_10","description","_hoisted_11","_component_el_tag","type","default","_withCtx","_component_el_rate","modelValue","value","_cache","$event","disabled","_","_createTextVNode","_hoisted_12","_component_el_button","onClick","router","push","LiveId","followed","_createBlock","key","followShop","unFollowShop","_hoisted_13","_hoisted_14","_hoisted_15","_hoisted_16","_hoisted_17","_hoisted_18","onlineUsers","length","_hoisted_19","_renderList","user","index","_hoisted_20","_hoisted_21","_hoisted_22","chatMessages","message","_hoisted_23","_hoisted_24","sender","innerHTML","content","_hoisted_25","_hoisted_26","_Transition","showEmojiPicker","_component_emoji_picker","onEmojiClick","addEmoji","toggleEmojiPicker","_hoisted_27","chatInput","placeholder","maxlength","onKeyup","_withKeys","sendMessage","loading"],"sources":["D:\\Cache\\Java\\shopping\\shoppping_c_frontend\\src\\views\\LiveView.vue"],"sourcesContent":["<template>\r\n  <div class=\"my-haichao-page\">\r\n    <HeaderComponent/>\r\n    <div class=\"live-stream-container\" v-loading=\"loading\">\r\n      <!-- 头部信息 -->\r\n      <div class=\"header bg-light d-flex align-items-center p-3 shadow-sm row\">\r\n        <div class=\"col-7 row\">\r\n          <div class=\"col-3 row\">\r\n            <div class=\"col-3\">\r\n              <img :src=\"shopForm.avatar\" class=\"shop-avatar\" alt=\"shop-avatar\" width=\"50\" height=\"50\"/>\r\n            </div>\r\n            <div class=\"col-9\">\r\n              <p class=\"shop-name\" style=\"font-size: 16px; \">{{ shopForm.name }}</p>\r\n              <p class=\"shop-desc\" style=\"font-size: 14px;\">{{ shopForm.description }}</p>\r\n            </div>\r\n          </div>\r\n          <div class=\"col-7\" style=\"margin-top: 15px;\">\r\n            <el-tag type=\"danger\">\r\n              <el-rate\r\n                  v-model=\"value\"\r\n                  disabled\r\n                  show-score\r\n                  text-color=\"#e23030\"\r\n                  score-template=\"|&nbsp;&nbsp;{value}\"\r\n              />\r\n            </el-tag>\r\n            &nbsp;\r\n            <el-tag type=\"info\">\r\n              客服满意度96%\r\n            </el-tag>\r\n            &nbsp;\r\n            <el-tag type=\"info\">\r\n              平均13小时发货\r\n            </el-tag>\r\n            &nbsp;\r\n            <el-tag type=\"info\">\r\n              物流体验优秀\r\n            </el-tag>\r\n          </div>\r\n        </div>\r\n        <div class=\"col-1 row\" style=\"text-align: start;\">\r\n        </div>\r\n        <div class=\"col-4\" style=\"margin-top: 15px; text-align: end;\">\r\n          <el-button @click=\"()=>{router.push('/talkToStore?id=' + LiveId)}\">\r\n            <a class=\"bi bi-chat\"></a>&nbsp;\r\n            联系客服\r\n          </el-button>\r\n          <el-button @click=\"()=>{router.push('/shop?shopId=' + LiveId)}\">\r\n            <a class=\"bi bi-house\"></a>\r\n            进入店铺\r\n          </el-button>\r\n          <el-button v-if=\"!followed\" @click=\"followShop()\">\r\n            <a class=\"bi bi-share-fill\"></a>\r\n            关注店铺\r\n          </el-button>\r\n          <el-button v-else @click=\"unFollowShop()\">\r\n            <a class=\"bi bi-share-fill\"></a>\r\n            取消关注\r\n          </el-button>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- 主体内容 -->\r\n      <div class=\"content-container d-flex\">\r\n        <!-- 视频播放区 -->\r\n        <div class=\"video-section flex-grow-1\">\r\n          <video id=\"video2\" ref=\"video2\" autoplay\r\n                 style=\"width: 100%; height: 100%; object-fit: cover;\"></video>\r\n        </div>\r\n\r\n        <!-- 在线用户和聊天区域 -->\r\n        <div class=\"side-panel bg-light p-3\">\r\n          <!-- 在线用户列表 -->\r\n          <div class=\"online-users mb-4\">\r\n            <h6 class=\"text-danger\">在线人员 ({{ onlineUsers.length }})</h6>\r\n            <ul class=\"list-unstyled\">\r\n              <li\r\n                  v-for=\"(user, index) in onlineUsers\"\r\n                  :key=\"index\"\r\n                  class=\"d-flex align-items-center mb-2\"\r\n              >\r\n                <img\r\n                    class=\"user-avatar-sm rounded-circle me-2\"\r\n                    :src=\"user.avatar\"\r\n                    alt=\"用户头像\"\r\n                />\r\n                <span>{{ user.name }}</span>\r\n              </li>\r\n            </ul>\r\n          </div>\r\n\r\n          <!-- 聊天区 -->\r\n          <div class=\"chat-section\">\r\n            <h6 class=\"text-primary\">聊天区</h6>\r\n            <div class=\"chat-messages border rounded p-2 mb-3\" ref=\"chatWindowRef\">\r\n              <div\r\n                  v-for=\"(message, index) in chatMessages\"\r\n                  :key=\"index\"\r\n                  class=\"d-flex align-items-start mb-2\"\r\n              >\r\n                <img\r\n                    class=\"user-avatar-sm rounded-circle me-2\"\r\n                    :src=\"message.avatar\"\r\n                    alt=\"用户头像\"\r\n                    width=\"35\"\r\n                    height=\"35\"\r\n                />\r\n                <div>\r\n                  <p class=\"mb-1\">\r\n                    <strong>{{ message.sender }}</strong>\r\n                    <el-tag type=\"danger\" v-if=\"message.type === 'shop' && message.id === LiveId.value\">\r\n                      商家\r\n                    </el-tag>\r\n                  </p>\r\n                  <p class=\"text-muted mb-0\" v-html=\"message.content\"></p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <!-- 聊天输入框 -->\r\n            <div style=\"text-align: start;\">\r\n              <transition name=\"fade\">\r\n                <emoji-picker\r\n                    v-if=\"showEmojiPicker\"\r\n                    @emoji-click=\"addEmoji\"\r\n                    style=\"position: absolute; bottom:200px; right: 100px;\"\r\n                ></emoji-picker>\r\n              </transition>\r\n              <i class=\"bi bi-emoji-smile me-3\" style=\"font-size: 1.5rem; cursor: pointer;\"\r\n                 @click=\"toggleEmojiPicker\"></i>\r\n            </div>\r\n            <div class=\"input-group\">\r\n              <input\r\n                  type=\"text\"\r\n                  v-model=\"chatInput\"\r\n                  class=\"form-control\"\r\n                  placeholder=\"输入50字以内聊天内容~\"\r\n                  maxlength=\"50\"\r\n                  @keyup.enter=\"sendMessage\"\r\n              />\r\n              <button class=\"btn btn-danger\" @click=\"sendMessage\">发送</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <FooterComponent/>\r\n  <RightWidgetComponent></RightWidgetComponent>\r\n</template>\r\n\r\n<script setup>\r\nimport HeaderComponent from \"@/components/HeaderComponent.vue\";\r\nimport RightWidgetComponent from \"@/components/RightWidgetComponent.vue\";\r\nimport FooterComponent from \"@/components/FooterComponent.vue\";\r\nimport useUser from \"@/composables/useUser\";\r\nimport {nextTick, onMounted, ref} from \"vue\";\r\nimport router from \"@/router\";\r\nimport {ElMessage} from \"element-plus\";\r\nimport axios from \"axios\";\r\nimport 'emoji-picker-element';\r\n\r\nconst {UserInfoForm, initUserSession} = useUser()\r\n\r\nconst LiveId = ref();\r\nconst loading = ref(false);\r\n\r\nfunction getLiveId() {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  const liveId = urlParams.get(\"id\");\r\n  if (liveId) {\r\n    LiveId.value = liveId;\r\n  } else {\r\n    ElMessage.error(\"直播间不存在\")\r\n    router.push({name: \"index\"});\r\n  }\r\n}\r\n\r\nasync function play() {\r\n  const httpURL = \"http://localhost:1985/rtc/v1/play/\";\r\n  const webRTCURL = `webRTC://localhost/live/${LiveId.value}`;\r\n  console.log(httpURL, webRTCURL);\r\n  const localPc = new RTCPeerConnection();\r\n  const stream = new MediaStream();\r\n  const videoElement2 = document.querySelector(\"#video2\");\r\n\r\n  localPc.ontrack = (event) => {\r\n    stream.addTrack(event.track);\r\n    console.log(event.track);\r\n    videoElement2.srcObject = stream;\r\n  };\r\n\r\n  localPc.addTransceiver(\"audio\", {direction: \"recvonly\"});\r\n  localPc.addTransceiver(\"video\", {direction: \"recvonly\"});\r\n\r\n  const offer = await localPc.createOffer();\r\n  await localPc.setLocalDescription(offer);\r\n  const data = {\r\n    \"api\": httpURL,\r\n    \"streamurl\": webRTCURL,\r\n    \"sdp\": offer.sdp\r\n  };\r\n\r\n  httpApi(httpURL, data).then(async (data) => {\r\n    console.log(\"answer\", data);\r\n    await localPc.setRemoteDescription(new RTCSessionDescription({type: 'answer', sdp: data.sdp}));\r\n  }).catch((data) => {\r\n    if (data.code === 400) {\r\n      console.log(\"SDP交换失败\");\r\n    }\r\n  });\r\n}\r\n\r\nfunction httpApi(httpURL, data) {\r\n  return new Promise((resolve, reject) => {\r\n    const xhr = new XMLHttpRequest();\r\n    xhr.open('POST', httpURL, true);\r\n    xhr.setRequestHeader('Content-type', 'application/json');\r\n    xhr.send(JSON.stringify(data));\r\n    xhr.onload = () => {\r\n      if (xhr.readyState !== xhr.DONE) reject(xhr);\r\n      if (xhr.status !== 200 && xhr.status !== 201) reject(xhr);\r\n      const responseData = JSON.parse(xhr.responseText);\r\n      if (responseData.code === 0) {\r\n        resolve(responseData);\r\n      } else {\r\n        reject(responseData);\r\n      }\r\n    };\r\n  });\r\n}\r\n\r\nlet socket;\r\nconst initWebSocket = () => {\r\n  const shopId = LiveId.value;\r\n  socket = new WebSocket(`ws://localhost:8888/channel/live/${shopId}`);\r\n\r\n  socket.onopen = () => {\r\n    console.log(\"WebSocket 连接已建立\");\r\n  };\r\n\r\n  socket.onmessage = (event) => {\r\n    const message = JSON.parse(event.data);\r\n    handleNotification(message);\r\n  };\r\n\r\n  socket.onclose = () => {\r\n    console.log(\"WebSocket 连接已关闭\");\r\n  };\r\n\r\n  socket.onerror = (error) => {\r\n    console.error(\"WebSocket 连接出错:\", error);\r\n  };\r\n};\r\n\r\n// 处理通知\r\nconst handleNotification = async (message) => {\r\n  if (message.message === \"updateUser\")\r\n    await initOnlineUsers();\r\n  else if (message.message === \"updateMessage\")\r\n    await initChatMessages();\r\n  else if (message.message === \"liveStart\")\r\n    ElMessage.success(\"主播回来了，快来围观！\");\r\n  else if (message.message === \"liveClose\")\r\n    ElMessage.error(\"主播下线了，感谢观看！\");\r\n};\r\n\r\nconst onlineUsers = ref([]);\r\nconst shopForm = ref({});\r\nconst value = ref(4.8);\r\n\r\nasync function initLiveInfo() {\r\n  try {\r\n    const response = await axios.post(\"/api/live/getLiveInfo\", {\r\n      roomId: LiveId.value,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    if (response.data !== null) {\r\n      shopForm.value = response.data;\r\n    } else\r\n      ElMessage.error(\"直播间不存在\")\r\n  } catch (err) {\r\n    ElMessage.error(\"获取直播间信息失败，请稍后再试\")\r\n  }\r\n}\r\n\r\nasync function initOnlineUsers() {\r\n  try {\r\n    const response = await axios.post('/api/live/getOnlineUserList', {\r\n      roomId: LiveId.value,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    onlineUsers.value = response.data;\r\n  } catch (err) {\r\n    ElMessage.error(\"获取在线用户列表失败，请稍后再试\");\r\n  }\r\n}\r\n\r\nconst chatMessages = ref([]);\r\nconst chatWindowRef = ref(null);\r\n\r\nasync function initChatMessages() {\r\n  try {\r\n    const response = await axios.post('/api/live/getLiveMessageList', {\r\n      roomId: LiveId.value,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    chatMessages.value = response.data;\r\n    await nextTick(() => {\r\n      const chatWindow = chatWindowRef.value;\r\n      if (chatWindow) {\r\n        chatWindow.scrollTop = chatWindow.scrollHeight;\r\n      }\r\n    });\r\n  } catch (error) {\r\n    ElMessage.error(\"获取聊天记录失败，请稍后再试\");\r\n  }\r\n}\r\n\r\nasync function insertOnlineUser() {\r\n  try {\r\n    const response = await axios.post('/api/live/insertOnlineUser', {\r\n      roomId: LiveId.value,\r\n      userId: UserInfoForm.value.id,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    if (response.data.code !== 200)\r\n      ElMessage.error(\"插入在线用户失败，请稍后再试\");\r\n  } catch (err) {\r\n    ElMessage.error(\"插入在线用户失败，请稍后再试\");\r\n  }\r\n}\r\n\r\nasync function deleteOnlineUser() {\r\n  try {\r\n    const response = await axios.post('/api/live/deleteOnlineUser', {\r\n      roomId: LiveId.value,\r\n      userId: UserInfoForm.value.id,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    if (response.data.code !== 200)\r\n      ElMessage.error(\"删除在线用户失败，请稍后再试\");\r\n  } catch (err) {\r\n    ElMessage.error(\"删除在线用户失败，请稍后再试\");\r\n  }\r\n}\r\n\r\nasync function init() {\r\n  await initLiveInfo();\r\n  await initFollowShop();\r\n  await insertOnlineUser();\r\n  await initOnlineUsers();\r\n  await initChatMessages();\r\n}\r\n\r\nconst followed = ref(false);\r\n\r\nasync function initFollowShop() {\r\n  try {\r\n    const response = await axios.post('/api/shop/findFollowShop', {\r\n      userId: UserInfoForm.value.id,\r\n      shopId: LiveId.value,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    followed.value = response.data.code === 200;\r\n  } catch (err) {\r\n    ElMessage.error('获取关注状态失败，请稍后再试');\r\n  }\r\n}\r\n\r\nasync function followShop() {\r\n  try {\r\n    const response = await axios.post('/api/shop/followShop', {\r\n      userId: UserInfoForm.value.id,\r\n      shopId: LiveId.value,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    if (response.data.code === 200) {\r\n      followed.value = true;\r\n      ElMessage.success('关注成功');\r\n    } else {\r\n      ElMessage.error('关注失败，请稍后再试');\r\n    }\r\n  } catch (err) {\r\n    ElMessage.error('关注失败，请稍后再试');\r\n  }\r\n}\r\n\r\nasync function unFollowShop() {\r\n  try {\r\n    const response = await axios.post('/api/shop/unfollowShop', {\r\n      userId: UserInfoForm.value.id,\r\n      shopId: LiveId.value,\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    if (response.data.code === 200) {\r\n      followed.value = false;\r\n      ElMessage.success('取消关注成功');\r\n    } else {\r\n      ElMessage.error('取消关注失败，请稍后再试');\r\n    }\r\n  } catch (err) {\r\n    ElMessage.error('取消关注失败，请稍后再试');\r\n  }\r\n}\r\n\r\nconst chatInput = ref(\"\");\r\nconst showEmojiPicker = ref(false);\r\n\r\nconst toggleEmojiPicker = () => {\r\n  showEmojiPicker.value = !showEmojiPicker.value;\r\n};\r\n\r\nconst addEmoji = (event) => {\r\n  chatInput.value += event.detail.unicode;\r\n};\r\n\r\nasync function sendMessage() {\r\n  if (!chatInput.value) return;\r\n  try {\r\n    const response = await axios.post('/api/live/insertLiveMessage', {\r\n      roomId: LiveId.value,\r\n      sendId: UserInfoForm.value.id,\r\n      message: chatInput.value,\r\n      sendType: \"user\"\r\n    }, {\r\n      headers: {\r\n        'Content-Type': 'application/json;charset=UTF-8'\r\n      },\r\n      withCredentials: true,\r\n    });\r\n    if (response.data.code !== 200)\r\n      ElMessage.error(\"发送失败，请稍后再试\")\r\n    else\r\n      chatInput.value = \"\";\r\n  } catch (err) {\r\n    ElMessage.error(\"发送失败，请稍后再试\")\r\n  }\r\n}\r\n\r\nconst closeWebSocket = async () => {\r\n  if (socket) {\r\n    await deleteOnlineUser()\r\n    socket.close();\r\n    socket = null; // 清空socket变量\r\n  }\r\n};\r\n\r\nonMounted(async () => {\r\n  loading.value = true\r\n  initUserSession()\r\n  getLiveId()\r\n  if (LiveId.value !== undefined) {\r\n    initWebSocket()\r\n    await init()\r\n    await play()\r\n    loading.value = false\r\n  }\r\n})\r\n\r\nwindow.addEventListener('beforeunload', closeWebSocket);\r\n\r\nrouter.beforeEach((to, from, next) => {\r\n  closeWebSocket(); // 在路由跳转时关闭WebSocket连接\r\n  next(); // 继续导航\r\n});\r\n</script>\r\n\r\n<style scoped>\r\n\r\n.live-stream-container {\r\n  display: flex;\r\n  flex-direction: column;\r\n  height: 80vh;\r\n  margin-top: 80px;\r\n  margin-bottom: 10px;\r\n}\r\n\r\n/* 头部信息样式 */\r\n.header {\r\n  display: flex;\r\n  align-items: center;\r\n  border-bottom: 1px solid #ddd;\r\n}\r\n\r\n.user-avatar {\r\n  width: 50px;\r\n  height: 50px;\r\n}\r\n\r\n/* 主体内容布局 */\r\n.content-container {\r\n  flex: 1;\r\n  display: flex;\r\n  overflow: hidden;\r\n}\r\n\r\n/* 视频区域 */\r\n.video-section {\r\n  flex-grow: 1;\r\n  background: #000;\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n}\r\n\r\n.video-player {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n\r\n/* 在线用户和聊天区域 */\r\n.side-panel {\r\n  width: 300px;\r\n  border-left: 1px solid #ddd;\r\n  overflow-y: auto;\r\n}\r\n\r\n.online-users img.user-avatar-sm {\r\n  width: 30px;\r\n  height: 30px;\r\n}\r\n\r\n.chat-section .chat-messages {\r\n  min-height: 45vh;\r\n  max-height: 45vh;\r\n  overflow-y: auto;\r\n}\r\n\r\n.chat-section .input-group {\r\n  display: flex;\r\n  max-height: 50px;\r\n}\r\n</style>"],"mappings":";;;EACOA,KAAK,EAAC;AAAiB;;EAErBA,KAAK,EAAC;AAAuB;;EAE3BA,KAAK,EAAC;AAA6D;;EACjEA,KAAK,EAAC;AAAW;;EACfA,KAAK,EAAC;AAAW;;EACfA,KAAK,EAAC;AAAO;mBAR9B;;EAWiBA,KAAK,EAAC;AAAO;;EACbA,KAAK,EAAC,WAAW;EAACC,KAAyB,EAAzB;IAAA;EAAA;;;EAClBD,KAAK,EAAC,WAAW;EAACC,KAAwB,EAAxB;IAAA;EAAA;;;EAGpBD,KAAK,EAAC,OAAO;EAACC,KAAyB,EAAzB;IAAA;EAAA;;;EA0BhBD,KAAK,EAAC,OAAO;EAACC,KAA0C,EAA1C;IAAA;IAAA;EAAA;;;EAqBhBD,KAAK,EAAC;AAA0B;;EAE9BA,KAAK,EAAC;AAA2B;;EAC7BE,EAAE,EAAC,QAAQ;EAACC,GAAG,EAAC,QAAQ;EAACC,QAAQ,EAAR,EAAQ;EACjCH,KAAqD,EAArD;IAAA;IAAA;IAAA;EAAA;;;EAIJD,KAAK,EAAC;AAAyB;;EAE7BA,KAAK,EAAC;AAAmB;;EACxBA,KAAK,EAAC;AAAa;;EACnBA,KAAK,EAAC;AAAe;oBA3ErC;;EA4FeA,KAAK,EAAC;AAAc;;EAElBA,KAAK,EAAC,uCAAuC;EAACG,GAAG,EAAC;;oBA9FnE;;EA4GqBH,KAAK,EAAC;AAAM;oBA5GjC;;EAwHiBC,KAA0B,EAA1B;IAAA;EAAA;AAA0B;;EAW1BD,KAAK,EAAC;AAAa;;;;;;;uBAnIpCK,mBAAA,CAAAC,SAAA,SACEC,mBAAA,CAiJM,OAjJNC,UAiJM,GAhJJC,YAAA,CAAkBC,MAAA,sB,+BAClBL,mBAAA,CA8IM,OA9INM,UA8IM,GA7IJC,mBAAA,UAAa,EACbL,mBAAA,CAuDM,OAvDNM,UAuDM,GAtDJN,mBAAA,CAiCM,OAjCNO,UAiCM,GAhCJP,mBAAA,CAQM,OARNQ,UAQM,GAPJR,mBAAA,CAEM,OAFNS,UAEM,GADJT,mBAAA,CAA0F;IAApFU,GAAG,EAAEP,MAAA,CAAAQ,QAAQ,CAACC,MAAM;IAAEnB,KAAK,EAAC,aAAa;IAACoB,GAAG,EAAC,aAAa;IAACC,KAAK,EAAC,IAAI;IAACC,MAAM,EAAC;0BATlGC,UAAA,E,GAWYhB,mBAAA,CAGM,OAHNiB,UAGM,GAFJjB,mBAAA,CAAsE,KAAtEkB,UAAsE,EAAAC,gBAAA,CAApBhB,MAAA,CAAAQ,QAAQ,CAACS,IAAI,kBAC/DpB,mBAAA,CAA4E,KAA5EqB,WAA4E,EAAAF,gBAAA,CAA3BhB,MAAA,CAAAQ,QAAQ,CAACW,WAAW,iB,KAGzEtB,mBAAA,CAsBM,OAtBNuB,WAsBM,GArBJrB,YAAA,CAQSsB,iBAAA;IARDC,IAAI,EAAC;EAAQ;IAjBjCC,OAAA,EAAAC,QAAA,CAkBc,MAME,CANFzB,YAAA,CAME0B,kBAAA;MAxBhBC,UAAA,EAmB2B1B,MAAA,CAAA2B,KAAK;MAnBhC,uBAAAC,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAmB2B7B,MAAA,CAAA2B,KAAK,GAAAE,MAAA;MACdC,QAAQ,EAAR,EAAQ;MACR,YAAU,EAAV,EAAU;MACV,YAAU,EAAC,SAAS;MACpB,gBAAc,EAAC;;IAvBjCC,CAAA;gCAAAC,gBAAA,CAyBqB,KAET,IAAAjC,YAAA,CAESsB,iBAAA;IAFDC,IAAI,EAAC;EAAM;IA3B/BC,OAAA,EAAAC,QAAA,CA2BgC,MAEpBI,MAAA,QAAAA,MAAA,OA7BZI,gBAAA,CA2BgC,YAEpB,E;IA7BZD,CAAA;kCAAAC,gBAAA,CA6BqB,KAET,IAAAjC,YAAA,CAESsB,iBAAA;IAFDC,IAAI,EAAC;EAAM;IA/B/BC,OAAA,EAAAC,QAAA,CA+BgC,MAEpBI,MAAA,QAAAA,MAAA,OAjCZI,gBAAA,CA+BgC,YAEpB,E;IAjCZD,CAAA;kCAAAC,gBAAA,CAiCqB,KAET,IAAAjC,YAAA,CAESsB,iBAAA;IAFDC,IAAI,EAAC;EAAM;IAnC/BC,OAAA,EAAAC,QAAA,CAmCgC,MAEpBI,MAAA,QAAAA,MAAA,OArCZI,gBAAA,CAmCgC,UAEpB,E;IArCZD,CAAA;sCAwCQlC,mBAAA,CACM;IADDP,KAAK,EAAC,WAAW;IAACC,KAA0B,EAA1B;MAAA;IAAA;+BAEvBM,mBAAA,CAiBM,OAjBNoC,WAiBM,GAhBJlC,YAAA,CAGYmC,oBAAA;IAHAC,OAAK,EAAAP,MAAA,QAAAA,MAAA;MAAO5B,MAAA,CAAAoC,MAAM,CAACC,IAAI,sBAAsBrC,MAAA,CAAAsC,MAAM;IAAA;;IA3CzEf,OAAA,EAAAC,QAAA,CA4CY,MAA0BI,MAAA,SAAAA,MAAA,QAA1B/B,mBAAA,CAA0B;MAAvBP,KAAK,EAAC;IAAY,4BA5CjC0C,gBAAA,CA4CsC,SAE5B,E;IA9CVD,CAAA;MA+CUhC,YAAA,CAGYmC,oBAAA;IAHAC,OAAK,EAAAP,MAAA,QAAAA,MAAA;MAAO5B,MAAA,CAAAoC,MAAM,CAACC,IAAI,mBAAmBrC,MAAA,CAAAsC,MAAM;IAAA;;IA/CtEf,OAAA,EAAAC,QAAA,CAgDY,MAA2BI,MAAA,SAAAA,MAAA,QAA3B/B,mBAAA,CAA2B;MAAxBP,KAAK,EAAC;IAAa,4BAhDlC0C,gBAAA,CAgDuC,QAE7B,E;IAlDVD,CAAA;OAmD4B/B,MAAA,CAAAuC,QAAQ,I,cAA1BC,YAAA,CAGYN,oBAAA;IAtDtBO,GAAA;IAmDuCN,OAAK,EAAAP,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAE7B,MAAA,CAAA0C,UAAU;;IAnDxDnB,OAAA,EAAAC,QAAA,CAoDY,MAAgCI,MAAA,SAAAA,MAAA,QAAhC/B,mBAAA,CAAgC;MAA7BP,KAAK,EAAC;IAAkB,4BApDvC0C,gBAAA,CAoD4C,QAElC,E;IAtDVD,CAAA;uBAuDUS,YAAA,CAGYN,oBAAA;IA1DtBO,GAAA;IAuD6BN,OAAK,EAAAP,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAE7B,MAAA,CAAA2C,YAAY;;IAvDhDpB,OAAA,EAAAC,QAAA,CAwDY,MAAgCI,MAAA,SAAAA,MAAA,QAAhC/B,mBAAA,CAAgC;MAA7BP,KAAK,EAAC;IAAkB,4BAxDvC0C,gBAAA,CAwD4C,QAElC,E;IA1DVD,CAAA;WA8DM7B,mBAAA,UAAa,EACbL,mBAAA,CAiFM,OAjFN+C,WAiFM,GAhFJ1C,mBAAA,WAAc,EACdL,mBAAA,CAGM,OAHNgD,WAGM,GAFJhD,mBAAA,CACqE,SADrEiD,WACqE,8B,GAGvE5C,mBAAA,eAAkB,EAClBL,mBAAA,CAwEM,OAxENkD,WAwEM,GAvEJ7C,mBAAA,YAAe,EACfL,mBAAA,CAgBM,OAhBNmD,WAgBM,GAfJnD,mBAAA,CAA4D,MAA5DoD,WAA4D,EAApC,QAAM,GAAAjC,gBAAA,CAAGhB,MAAA,CAAAkD,WAAW,CAACC,MAAM,IAAG,GAAC,iBACvDtD,mBAAA,CAaK,MAbLuD,WAaK,I,kBAZHzD,mBAAA,CAWKC,SAAA,QAvFnByD,WAAA,CA6E0CrD,MAAA,CAAAkD,WAAW,EA7ErD,CA6E0BI,IAAI,EAAEC,KAAK;yBADvB5D,mBAAA,CAWK;MATA8C,GAAG,EAAEc,KAAK;MACXjE,KAAK,EAAC;QAERO,mBAAA,CAIE;MAHEP,KAAK,EAAC,oCAAoC;MACzCiB,GAAG,EAAE+C,IAAI,CAAC7C,MAAM;MACjBC,GAAG,EAAC;4BApFxB8C,WAAA,GAsFgB3D,mBAAA,CAA4B,cAAAmB,gBAAA,CAAnBsC,IAAI,CAACrC,IAAI,iB;sCAKxBf,mBAAA,SAAY,EACZL,mBAAA,CAkDM,OAlDN4D,WAkDM,G,4BAjDJ5D,mBAAA,CAAiC;IAA7BP,KAAK,EAAC;EAAc,GAAC,KAAG,sBAC5BO,mBAAA,CAuBM,OAvBN6D,WAuBM,I,kBAtBJ/D,mBAAA,CAqBMC,SAAA,QApHpByD,WAAA,CAgG6CrD,MAAA,CAAA2D,YAAY,EAhGzD,CAgG0BC,OAAO,EAAEL,KAAK;yBAD1B5D,mBAAA,CAqBM;MAnBD8C,GAAG,EAAEc,KAAK;MACXjE,KAAK,EAAC;QAERO,mBAAA,CAME;MALEP,KAAK,EAAC,oCAAoC;MACzCiB,GAAG,EAAEqD,OAAO,CAACnD,MAAM;MACpBC,GAAG,EAAC,MAAM;MACVC,KAAK,EAAC,IAAI;MACVC,MAAM,EAAC;4BAzG3BiD,WAAA,GA2GgBhE,mBAAA,CAQM,cAPJA,mBAAA,CAKI,KALJiE,WAKI,GAJFjE,mBAAA,CAAqC,gBAAAmB,gBAAA,CAA1B4C,OAAO,CAACG,MAAM,kBACGH,OAAO,CAACtC,IAAI,eAAesC,OAAO,CAACpE,EAAE,KAAKQ,MAAA,CAAAsC,MAAM,CAACX,KAAK,I,cAAlFa,YAAA,CAESnB,iBAAA;MAhH7BoB,GAAA;MA8G4BnB,IAAI,EAAC;;MA9GjCC,OAAA,EAAAC,QAAA,CA8GwG,MAEpF,KAAAI,MAAA,SAAAA,MAAA,QAhHpBI,gBAAA,CA8GwG,MAEpF,E;MAhHpBD,CAAA;UAAA7B,mBAAA,e,GAkHkBL,mBAAA,CAAwD;MAArDP,KAAK,EAAC,iBAAiB;MAAC0E,SAAwB,EAAhBJ,OAAO,CAACK;4BAlH7DC,WAAA,E;0DAuHYhE,mBAAA,WAAc,EACdL,mBAAA,CAUM,OAVNsE,WAUM,GATJpE,YAAA,CAMaqE,WAAA;IANDnD,IAAI,EAAC;EAAM;IAzHrCM,OAAA,EAAAC,QAAA,CAqHe,MAIV,CAEqBxB,MAAA,CAAAqE,eAAe,I,cADzB7B,YAAA,CAIgB8B,uBAAA;MA9HhC7B,GAAA;MA4HqB8B,YAAW,EAAEvE,MAAA,CAAAwE,QAAQ;MACtBjF,KAAuD,EAAvD;QAAA;QAAA;QAAA;MAAA;UA7HpBW,mBAAA,e;IAAA6B,CAAA;MAgIclC,mBAAA,CACkC;IAD/BP,KAAK,EAAC,wBAAwB;IAACC,KAA2C,EAA3C;MAAA;MAAA;IAAA,CAA2C;IACzE4C,OAAK,EAAEnC,MAAA,CAAAyE;QAEb5E,mBAAA,CAUM,OAVN6E,WAUM,G,gBATJ7E,mBAAA,CAOE;IANEyB,IAAI,EAAC,MAAM;IArI7B,uBAAAM,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAsI2B7B,MAAA,CAAA2E,SAAS,GAAA9C,MAAA;IAClBvC,KAAK,EAAC,cAAc;IACpBsF,WAAW,EAAC,cAAc;IAC1BC,SAAS,EAAC,IAAI;IACbC,OAAK,EA1IxBC,SAAA,CA0IgC/E,MAAA,CAAAgF,WAAW;iEAJhBhF,MAAA,CAAA2E,SAAS,E,GAMtB9E,mBAAA,CAA+D;IAAvDP,KAAK,EAAC,gBAAgB;IAAE6C,OAAK,EAAEnC,MAAA,CAAAgF;KAAa,IAAE,E,kCAzIlBhF,MAAA,CAAAiF,OAAO,E,KAgJvDlF,YAAA,CAAkBC,MAAA,sBAClBD,YAAA,CAA6CC,MAAA,0B","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}