{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { useUserShop } from \"@/composables/useShopUser\";\nimport { onMounted, ref } from \"vue\";\nimport router from \"@/router\";\nimport { ElNotification } from \"element-plus\";\nimport { useRoute } from \"vue-router\";\nexport default {\n  __name: 'ShopSliderComponent',\n  emits: ['initApplications', 'initChat'],\n  setup(__props, {\n    expose: __expose,\n    emit: __emit\n  }) {\n    const {\n      shopForm,\n      initUserSession,\n      initShopInfo,\n      UserForm\n    } = useUserShop();\n    const activeIndex = ref(\"1\");\n    const openedList = ref(['1', '3', '5']);\n    function setActiveIndex(index) {\n      activeIndex.value = index;\n    }\n    async function setOpenedList(role) {\n      if (role === \"merchant\") {\n        openedList.value.push('2', '4');\n        openedList.value.sort((a, b) => {\n          const indexA = parseInt(a.split('-')[0]);\n          const indexB = parseInt(b.split('-')[0]);\n          return indexA - indexB;\n        });\n      }\n    }\n    let socket;\n    const route = useRoute();\n    const initWebSocket = () => {\n      // 模拟商家端的用户 ID\n      const shopId = shopForm.value.shopID;\n      socket = new WebSocket(`ws://localhost:8888/channel/merchant/${shopId}`);\n      socket.onopen = () => {\n        console.log(\"WebSocket 连接已建立\");\n      };\n      socket.onmessage = event => {\n        const message = JSON.parse(event.data);\n        handleNotification(message);\n      };\n      socket.onclose = () => {\n        console.log(\"WebSocket 连接已关闭\");\n      };\n      socket.onerror = error => {\n        console.error(\"WebSocket 连接出错:\", error);\n      };\n    };\n    const emit = __emit;\n    // 处理通知\n    const handleNotification = message => {\n      if (message.type === \"order\") {\n        if (route.path === \"/store/orderList\") {\n          emit('initApplications');\n        } else {\n          // 显示订单通知\n          ElNotification({\n            title: '新订单通知',\n            message: message.message,\n            type: 'info',\n            onClick: () => {\n              router.push('/store/orderList');\n            }\n          });\n        }\n      } else if (message.type === \"return\") {\n        // 显示退换货通知\n        if (route.path === \"/store/orderReturns\") {\n          emit(\"initApplications\");\n        } else {\n          ElNotification({\n            title: '退换货通知',\n            message: message.message,\n            type: 'warning',\n            onClick: () => {\n              router.push('/store/orderReturns');\n            }\n          });\n        }\n      } else if (message.type === \"new_employee\") {\n        // 显示新增店员通知\n        if (UserForm.value.role === \"merchant\") {\n          if (route.path === \"/store/staffManage\") {\n            emit('initApplications');\n          } else {\n            ElNotification({\n              title: '新增店员通知',\n              message: message.message,\n              type: 'info',\n              onClick: () => {\n                router.push('/store/staffManage');\n              }\n            });\n          }\n        }\n      } else if (message.type === \"chat\") {\n        const idMatch = message.message.match(/id=(\\d+)\\s+(.*)/);\n        const id = idMatch[1];\n        if (route.path === \"/store/talk\") {\n          emit('initChat', id);\n        } else {\n          // 显示私信通知\n          ElNotification({\n            title: '私信通知',\n            message: idMatch[2],\n            type: 'info',\n            onClick: () => {\n              router.push('/store/talk?id=' + id);\n            }\n          });\n        }\n      }\n    };\n    __expose({\n      setActiveIndex\n    });\n    const closeWebSocket = () => {\n      if (socket) {\n        socket.close();\n        socket = null; // 清空socket变量\n      }\n    };\n    window.addEventListener('beforeunload', closeWebSocket);\n    router.beforeEach((to, from, next) => {\n      closeWebSocket(); // 在路由跳转时关闭WebSocket连接\n      next(); // 继续导航\n    });\n    onMounted(async () => {\n      initUserSession();\n      await setOpenedList(UserForm.value.role);\n      await initShopInfo();\n      initWebSocket();\n    });\n    const __returned__ = {\n      shopForm,\n      initUserSession,\n      initShopInfo,\n      UserForm,\n      activeIndex,\n      openedList,\n      setActiveIndex,\n      setOpenedList,\n      get socket() {\n        return socket;\n      },\n      set socket(v) {\n        socket = v;\n      },\n      route,\n      initWebSocket,\n      emit,\n      handleNotification,\n      closeWebSocket,\n      get useUserShop() {\n        return useUserShop;\n      },\n      onMounted,\n      ref,\n      get router() {\n        return router;\n      },\n      get ElNotification() {\n        return ElNotification;\n      },\n      get useRoute() {\n        return useRoute;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["useUserShop","onMounted","ref","router","ElNotification","useRoute","shopForm","initUserSession","initShopInfo","UserForm","activeIndex","openedList","setActiveIndex","index","value","setOpenedList","role","push","sort","a","b","indexA","parseInt","split","indexB","socket","route","initWebSocket","shopId","shopID","WebSocket","onopen","console","log","onmessage","event","message","JSON","parse","data","handleNotification","onclose","onerror","error","emit","__emit","type","path","title","onClick","idMatch","match","id","__expose","closeWebSocket","close","window","addEventListener","beforeEach","to","from","next"],"sources":["D:/Cache/Java/shopping/shoppping_c_frontend/src/components/ShopSliderComponent.vue"],"sourcesContent":["<template>\r\n  <aside class=\"bg-dark text-light\" style=\"width: 200px; padding-top: 20px;\">\r\n    <div class=\"text-center mb-4\">\r\n      <a style=\"font-size: 16px; font-weight: bold\" @click=\"()=> router.push('/store/index')\">{{\r\n          shopForm.shopName\r\n        }}</a>\r\n    </div>\r\n    <el-menu\r\n        :default-openeds=\"openedList\"\r\n        :default-active=\"activeIndex\"\r\n        class=\"border-0\"\r\n        text-color=\"#fff\"\r\n        active-text-color=\"#ffd04b\"\r\n        background-color=\"#333\"\r\n    >\r\n      <el-sub-menu index=\"1\">\r\n        <template #title>首页</template>\r\n        <el-menu-item index=\"1-1\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=> router.push('/store/index')\">首页\r\n        </el-menu-item>\r\n      </el-sub-menu>\r\n      <el-sub-menu index=\"2\" v-if=\"UserForm.role === 'merchant'\">\r\n        <template #title>商品管理</template>\r\n        <el-menu-item index=\"2-1\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=> {router.push('/store/mangerGood')}\">\r\n          商品列表\r\n        </el-menu-item>\r\n        <el-menu-item index=\"2-2\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=> {router.push('/store/traceabilityManage')}\">\r\n          溯源管理\r\n        </el-menu-item>\r\n      </el-sub-menu>\r\n      <el-sub-menu index=\"3\">\r\n        <template #title>订单管理</template>\r\n        <el-menu-item index=\"3-1\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=> {router.push('/store/orderList')}\">\r\n          订单列表\r\n        </el-menu-item>\r\n        <el-menu-item index=\"3-2\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=>{router.push('/store/orderReturns')}\">\r\n          退换货处理\r\n        </el-menu-item>\r\n      </el-sub-menu>\r\n      <el-sub-menu index=\"4\" v-if=\"UserForm.role === 'merchant'\">\r\n        <template #title>店员管理</template>\r\n        <el-menu-item index=\"4-1\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=> {router.push('/store/staffManage')}\">\r\n          店员列表\r\n        </el-menu-item>\r\n      </el-sub-menu>\r\n      <el-sub-menu index=\"5\">\r\n        <template #title>客服</template>\r\n        <el-menu-item index=\"5-1\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=>{router.push(('/store/talk'))}\">\r\n          在线客服\r\n        </el-menu-item>\r\n      </el-sub-menu>\r\n      <el-sub-menu index=\"6\">\r\n        <template #title>直播</template>\r\n        <el-menu-item index=\"6-1\"\r\n                      :disabled=\"shopForm.status === '未审核' || shopForm.status === '审核中' || shopForm.status === '审核失败'\"\r\n                      @click=\"()=>{router.push('/store/live')}\">\r\n          直播间\r\n        </el-menu-item>\r\n      </el-sub-menu>\r\n    </el-menu>\r\n\r\n  </aside>\r\n</template>\r\n\r\n<script setup>\r\nimport {useUserShop} from \"@/composables/useShopUser\";\r\nimport {defineEmits, defineExpose, onMounted, ref} from \"vue\";\r\nimport router from \"@/router\";\r\nimport {ElNotification} from \"element-plus\";\r\nimport {useRoute} from \"vue-router\";\r\n\r\nconst {shopForm, initUserSession, initShopInfo, UserForm} = useUserShop();\r\nconst activeIndex = ref(\"1\");\r\nconst openedList = ref(['1', '3', '5']);\r\n\r\nfunction setActiveIndex(index) {\r\n  activeIndex.value = index;\r\n}\r\n\r\nasync function setOpenedList(role) {\r\n  if (role === \"merchant\") {\r\n    openedList.value.push('2', '4')\r\n    openedList.value.sort((a, b) => {\r\n      const indexA = parseInt(a.split('-')[0]);\r\n      const indexB = parseInt(b.split('-')[0]);\r\n      return indexA - indexB;\r\n    });\r\n  }\r\n}\r\n\r\nlet socket;\r\nconst route = useRoute();\r\nconst initWebSocket = () => {\r\n// 模拟商家端的用户 ID\r\n  const shopId = shopForm.value.shopID;\r\n  socket = new WebSocket(`ws://localhost:8888/channel/merchant/${shopId}`);\r\n\r\n  socket.onopen = () => {\r\n    console.log(\"WebSocket 连接已建立\");\r\n  };\r\n\r\n  socket.onmessage = (event) => {\r\n    const message = JSON.parse(event.data);\r\n    handleNotification(message);\r\n  };\r\n\r\n  socket.onclose = () => {\r\n    console.log(\"WebSocket 连接已关闭\");\r\n  };\r\n\r\n  socket.onerror = (error) => {\r\n    console.error(\"WebSocket 连接出错:\", error);\r\n  };\r\n};\r\nconst emit = defineEmits(['initApplications', 'initChat']);\r\n// 处理通知\r\nconst handleNotification = (message) => {\r\n  if (message.type === \"order\") {\r\n    if (route.path === \"/store/orderList\") {\r\n      emit('initApplications')\r\n    } else {\r\n      // 显示订单通知\r\n      ElNotification({\r\n        title: '新订单通知',\r\n        message: message.message,\r\n        type: 'info',\r\n        onClick: () => {\r\n          router.push('/store/orderList')\r\n        }\r\n      });\r\n    }\r\n  } else if (message.type === \"return\") {\r\n    // 显示退换货通知\r\n    if (route.path === \"/store/orderReturns\") {\r\n      emit(\"initApplications\");\r\n    } else {\r\n      ElNotification({\r\n        title: '退换货通知',\r\n        message: message.message,\r\n        type: 'warning',\r\n        onClick: () => {\r\n          router.push('/store/orderReturns')\r\n        }\r\n      });\r\n    }\r\n  } else if (message.type === \"new_employee\") {\r\n    // 显示新增店员通知\r\n    if (UserForm.value.role === \"merchant\") {\r\n      if (route.path === \"/store/staffManage\") {\r\n        emit('initApplications')\r\n      } else {\r\n        ElNotification({\r\n          title: '新增店员通知',\r\n          message: message.message,\r\n          type: 'info',\r\n          onClick: () => {\r\n            router.push('/store/staffManage')\r\n          }\r\n        });\r\n      }\r\n    }\r\n  } else if (message.type === \"chat\") {\r\n    const idMatch = message.message.match(/id=(\\d+)\\s+(.*)/);\r\n    const id = idMatch[1];\r\n    if (route.path === \"/store/talk\") {\r\n      emit('initChat', id)\r\n    } else {\r\n      // 显示私信通知\r\n      ElNotification({\r\n        title: '私信通知',\r\n        message: idMatch[2],\r\n        type: 'info',\r\n        onClick: () => {\r\n          router.push('/store/talk?id=' + id);\r\n        }\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\ndefineExpose({setActiveIndex})\r\n\r\nconst closeWebSocket = () => {\r\n  if (socket) {\r\n    socket.close();\r\n    socket = null; // 清空socket变量\r\n  }\r\n};\r\n\r\nwindow.addEventListener('beforeunload', closeWebSocket);\r\n\r\nrouter.beforeEach((to, from, next) => {\r\n  closeWebSocket(); // 在路由跳转时关闭WebSocket连接\r\n  next(); // 继续导航\r\n});\r\n\r\nonMounted(async () => {\r\n  initUserSession();\r\n  await setOpenedList(UserForm.value.role);\r\n  await initShopInfo();\r\n  initWebSocket();\r\n});\r\n</script>\r\n<style scoped lang=\"less\">\r\n\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}